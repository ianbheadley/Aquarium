<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail Mock</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f6f8fc; }
        .ha { background: white; padding: 20px; border-bottom: 1px solid #ddd; }
        h2 { margin: 0; font-size: 1.5em; }
        .email-body { background: white; padding: 20px; margin-top: 20px; min-height: 300px; }
        .gD { font-weight: bold; color: #222; }
        .go { color: #666; font-size: 0.9em; }
    </style>
</head>
<body>
    <div role="main">
        <div class="ha">
            <h2 data-thread-perm-id="123">Important Security Alert: Update Account</h2>
            <div style="margin-top: 10px;">
                <span class="gD" email="support@secure-bank-alert.com">Chase Bank Security</span>
                <span class="go">&lt;support@secure-bank-alert.com&gt;</span>
            </div>
        </div>
        <div class="email-body">
            <div class="a3s">
                <p>Dear User,</p>
                <p>Your account is at risk. Please click here to verify your identity immediately.</p>
                <p><a href="http://phishing-site.com/login">Verify Now</a></p>
                <p><a href="https://www.chase.com/privacy">Privacy Policy</a></p>
            </div>
        </div>
    </div>

    <script>
        // Mock extraction logic to verify it works in this context (simulating what content.js does)
        function testExtraction() {
            const senderElement = document.querySelector('span.gD');
            const name = senderElement.innerText;
            const email = senderElement.getAttribute('email');

            const links = [];
            document.querySelectorAll('.a3s a').forEach(a => links.push(new URL(a.href).hostname));

            console.log("TEST_EXTRACTION:", { name, email, links });

            // Trigger message mock
            window.chrome.runtime.sendMessage({
                action: 'analyze_email',
                text: document.querySelector('.a3s').innerText,
                sender: { name, email },
                links: links
            });
        }

        // Mock chrome.runtime.sendMessage
        window.chrome = {
            runtime: {
                sendMessage: (msg) => {
                    console.log("Mock sendMessage called with:", msg);
                    // Verify data passed correctly
                    const isPhishing = (msg.sender.email.includes('alert.com') && msg.links.includes('phishing-site.com'));
                    return Promise.resolve({
                        isPhishing: isPhishing,
                        reason: `Sender domain ${msg.sender.email} does not match known safe domains.`
                    });
                }
            }
        };

        // Inject banner logic
        function showWarningBanner(reason) {
          if (document.getElementById('gmail-phishing-protector-banner')) return;
          const subjectHeader = document.querySelector('div.ha');
          const banner = document.createElement('div');
          banner.id = 'gmail-phishing-protector-banner';
          banner.style.cssText = 'background-color: #fef2f2; border: 1px solid #ef4444; color: #991b1b; padding: 16px; margin: 10px 0;';
          banner.innerHTML = `<strong>Potential Phishing Detected</strong><br>Reason: ${reason}`;
          subjectHeader.appendChild(banner);
        }

        // Simulate the flow
        setTimeout(() => {
            testExtraction();
        }, 500);

        // Simulate banner display on callback
        setTimeout(() => {
             showWarningBanner("Sender domain does not match known safe domains.");
        }, 1000);
    </script>
</body>
</html>